<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Erusian Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 1100px; }
    .row { display:flex; flex-wrap: wrap; gap: 12px; align-items: end; }
    label { display:flex; flex-direction:column; gap:4px; font-size:14px; }
    input, select { padding:8px; font-size:14px; min-width: 240px; }
    button { padding:10px 14px; font-size:14px; cursor:pointer; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0; }
    .meta { font-size:12px; opacity:.75; }
    .top { display:flex; justify-content:space-between; gap:12px; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    .links a { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Erusian Tracker</h1>
  <div class="meta" id="about"></div>

  <div class="row" style="margin-top:12px;">
    <label>Search
      <input id="q" placeholder="search text/title/url" />
    </label>
    <label>Sort
      <select id="sort">
        <option value="comment_newest">Comment date: newest</option>
        <option value="comment_oldest">Comment date: oldest</option>
        <option value="post_newest">Post date: newest</option>
        <option value="post_oldest">Post date: oldest</option>
        <option value="likes_desc">Likes: high ‚Üí low</option>
        <option value="likes_asc">Likes: low ‚Üí high</option>
        <option value="length_desc">Length: long ‚Üí short</option>
        <option value="length_asc">Length: short ‚Üí long</option>
      </select>
    </label>
    <label>Page size
      <select id="limit">
        <option>25</option>
        <option selected>50</option>
        <option>100</option>
        <option>200</option>
      </select>
    </label>
    <button id="apply">Apply</button>
    <button id="export">Export CSV (current page)</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="prev">Prev</button>
    <div class="meta" id="pageInfo"></div>
    <button id="next">Next</button>
  </div>

  <div id="err" style="color:crimson;margin-top:10px;"></div>
  <div id="results" style="margin-top:12px;"></div>

<script>
const el = (id) => document.getElementById(id);
const esc = (s) => (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
const fmt = (ms) => ms ? new Date(ms).toLocaleString() : "";

let data = null;
let filtered = [];
let offset = 0;

function sortRows(rows, mode){
  const copy = rows.slice();
  const by = {
    comment_newest: (a,b) => (b.commentDateMs||0) - (a.commentDateMs||0),
    comment_oldest: (a,b) => (a.commentDateMs||0) - (b.commentDateMs||0),
    post_newest: (a,b) => (b.postDateMs||0) - (a.postDateMs||0) || ((b.commentDateMs||0)-(a.commentDateMs||0)),
    post_oldest: (a,b) => (a.postDateMs||0) - (b.postDateMs||0) || ((b.commentDateMs||0)-(a.commentDateMs||0)),
    likes_desc: (a,b) => (b.likes||0) - (a.likes||0) || ((b.commentDateMs||0)-(a.commentDateMs||0)),
    likes_asc: (a,b) => (a.likes||0) - (b.likes||0) || ((b.commentDateMs||0)-(a.commentDateMs||0)),
    length_desc: (a,b) => (b.text?.length||0) - (a.text?.length||0),
    length_asc: (a,b) => (a.text?.length||0) - (b.text?.length||0)
  }[mode] || ((a,b)=>0);
  copy.sort(by);
  return copy;
}

function apply(){
  const q = el("q").value.trim().toLowerCase();
  const sort = el("sort").value;
  const limit = Number(el("limit").value);

  let rows = data.rows || [];
  if (q){
    rows = rows.filter(r => {
      const hay = `${r.text||""} ${r.postTitle||""} ${r.postUrl||""}`.toLowerCase();
      return hay.includes(q);
    });
  }
  rows = sortRows(rows, sort);

  filtered = rows;
  offset = 0;
  render(limit);
}

function render(limit){
  const total = filtered.length;
  const page = Math.floor(offset / limit) + 1;
  const pages = Math.max(1, Math.ceil(total / limit));

  el("prev").disabled = page <= 1;
  el("next").disabled = page >= pages;
  el("pageInfo").textContent = `Page ${page}/${pages} ‚Äî ${total} comments`;

  const slice = filtered.slice(offset, offset + limit);

  el("results").innerHTML = slice.map(r => {
    const postTitle = esc(r.postTitle || "(untitled)");
    const postUrl = esc(r.postUrl);

    const links = [];
    if (r.commentUrl) {
      links.push(`<a target="_blank" rel="noreferrer" href="${esc(r.commentUrl)}">comment link</a>`);
    }
    // NEW: show top-level link when it's different from the comment link
    if (r.topLevelCommentUrl && (!r.commentUrl || r.topLevelCommentUrl !== r.commentUrl)) {
      links.push(`<a target="_blank" rel="noreferrer" href="${esc(r.topLevelCommentUrl)}">top-level</a>`);
    }

    const linksHtml = links.length ? `<span class="links">${links.join("")}</span>` : "";

    return `
      <div class="card">
        <div class="top">
          <div>
            <div><b>${postTitle}</b> ‚Äî <a target="_blank" rel="noreferrer" href="${postUrl}">open post</a></div>
            <div class="meta">Comment: ${fmt(r.commentDateMs)} | üëç ${r.likes||0}</div>
          </div>
          <div class="meta" style="text-align:right">${linksHtml}</div>
        </div>
        <div style="white-space:pre-wrap;margin-top:8px;">${esc(r.text||"")}</div>
      </div>
    `;
  }).join("") || "<div class='meta'>No results.</div>";
}

function exportCsvCurrentPage(){
  const limit = Number(el("limit").value);
  const rows = filtered.slice(offset, offset + limit);

  const header = ["postTitle","postUrl","commentDate","likes","commentUrl","topLevelCommentUrl","text"];
  const lines = [header.join(",")];

  for (const r of rows){
    const vals = [
      r.postTitle || "",
      r.postUrl || "",
      r.commentDateMs ? new Date(r.commentDateMs).toISOString() : "",
      String(r.likes || 0),
      r.commentUrl || "",
      r.topLevelCommentUrl || "",
      (r.text || "").replaceAll("\r"," ").replaceAll("\n"," ")
    ].map(v => `"${String(v).replaceAll('"','""')}"`);
    lines.push(vals.join(","));
  }

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `comments_page.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function boot(){
  el("err").textContent = "";
  try{
    const r = await fetch("./data/comments.json", { cache: "no-store" });
    if (!r.ok) throw new Error("comments.json not found yet ‚Äî run the GitHub Action once.");
    data = await r.json();
    el("about").innerHTML = `Data for <code>${esc(data.substackUrl)}</code> user <code>${esc(data.username)}</code> ‚Ä¢ generated <code>${esc(data.generatedAt)}</code> ‚Ä¢ count <code>${data.count}</code>`;
    filtered = data.rows || [];
    apply();
  } catch(e){
    el("err").textContent = String(e.message || e);
  }
}

el("apply").addEventListener("click", apply);
el("prev").addEventListener("click", () => { offset = Math.max(0, offset - Number(el("limit").value)); render(Number(el("limit").value)); });
el("next").addEventListener("click", () => { offset = offset + Number(el("limit").value); render(Number(el("limit").value)); });
el("export").addEventListener("click", exportCsvCurrentPage);

boot();
</script>
</body>
</html>
